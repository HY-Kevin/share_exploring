k=16;
Fs = 60000000;%采样频率1MHz x=(randn(1, 200)+3) / 6 * 10;
len = 10000;%不能太小，否则在这边做验证时，滤波输出的FFT的频率不对
t = (0:len-1)/Fs;
% y = sin(2*pi*1000000*t)+sin(2*pi*2700000*t)+sin(2*pi*2500000*t)+cos(2*pi*3000000*t)+sin(2*pi*1800000*t)+sin(2*pi*3800000*t)+sin(2*pi*3200000*t)+sin(2*pi*4000000*t)+sin(2*pi*2800000*t)+(randn(1, 1000))/6;%并掺入随机噪声
% y = sin(2*pi*8000*t)+cos(2*pi*30000*t)+sin(2*pi*180000*t)+sin(2*pi*3800000*t)+sin(2*pi*3200000*t)+sin(2*pi*4000000*t)+sin(2*pi*2800000*t)+(randn(1, 10000))/10;%并掺入随机噪声
y = sin(2*pi*20000000*t)+sin(2*pi*25000000*t)+cos(2*pi*15000000*t)+sin(2*pi*16000000*t)+sin(2*pi*17000000*t)+sin(2*pi*23000000*t)+(randn(1, 10000))/20;
% y = sin(2*pi*1000000*t)+sin(2*pi*3000000*t)+sin(2*pi*2500000*t);
plot(t,y);
y_ad = y/max(abs(y));
q_ad=round(y_ad*(2^(k-1)-1));%进行16bit量化，配合后续的FPGA实现
%将信号导入文件
fid=fopen('D:\ele_match\FPGA_filter\signal_in.txt','w');
for i = 1:len
    if q_ad(i) >= 0
        fprintf(fid,'%X\n', q_ad(i));
    else
        fprintf(fid,'%X\n', q_ad(i)+2^k);
    end
end
fclose(fid);

%滤波下看看效果 - 滤波系数需要在量化处理前下个断点然后贴过来
% coeff =[-0.000670725257353326,-0.000792999076599835,0.000266038144856742,0.00242748622170168,0.00356423810419241,0.000966388550376318,-0.00522328831077981,-0.00991137450195772,-0.00608921327755592,0.00763839393725974,0.0216996619828801,0.0200433963479112,-0.00544243614741472,-0.0413925444277523,-0.0546325709158592,-0.0132631456339571,0.0859668556998134,0.206328460214929,0.288733383188963,0.288733383188963,0.206328460214929,0.0859668556998134,-0.0132631456339571,-0.0546325709158592,-0.0413925444277523,-0.00544243614741472,0.0200433963479112,0.0216996619828801,0.00763839393725974,-0.00608921327755592,-0.00991137450195772,-0.00522328831077981,0.000966388550376318,0.00356423810419241,0.00242748622170168,0.000266038144856742,-0.000792999076599835,-0.000670725257353326];
% coeff = [-0.000330979071680577,-5.50142418715581e-05,-5.83899233005294e-05,-6.10229386550884e-05,-6.28692390453495e-05,-6.38127740985618e-05,-6.38301129789967e-05,-6.28021442815492e-05,-6.06775372852928e-05,-5.72627411565912e-05,-5.24464439620379e-05,-4.60401338563882e-05,-3.81418191955563e-05,-2.89292280511830e-05,-1.87620889562028e-05,-6.09581720487578e-06,7.22475490810853e-06,2.21013480837777e-05,3.82510341149398e-05,5.55755553661594e-05,7.39730418405623e-05,9.32648674840754e-05,0.000113253209649522,0.000133747099984571,0.000154551235335883,0.000175478687368925,0.000196218684986828,0.000216428578703830,0.000235803526478832,0.000254366995067474,0.000271309827906738,0.000286654204484094,0.000299950722476214,0.000310906571276894,0.000319234192899831,0.000324616570972084,0.000326761188423756,0.000325403386669524,0.000320318482618341,0.000311316443630082,0.000298178717625201,0.000280735133725278,0.000258908777237841,0.000232748538042406,0.000202033044726100,0.000166989788645684,0.000127616922549539,8.40965046267350e-05,3.66497970938765e-05,-1.44729876149084e-05,-6.89493749203878e-05,-0.000126395144867116,-0.000186353183086686,-0.000248312819331449,-0.000311749035058021,-0.000376066023505732,-0.000440588239604649,-0.000504589905816540,-0.000567450331217877,-0.000628300176764747,-0.000686438549549766,-0.000741037621814470,-0.000791291260561520,-0.000836413796266533,-0.000875615638874054,-0.000908127506326589,-0.000933196723645475,-0.000950117565262102,-0.000958257697775645,-0.000957020586836878,-0.000945858638529490,-0.000924312674656017,-0.000892071954406799,-0.000848792994773484,-0.000794369411400013,-0.000728706958097283,-0.000651863609577927,-0.000564028415914168,-0.000465501135750361,-0.000356713223900428,-0.000238214625252847,-0.000110697102663998,2.50026051317746e-05,0.000167940366930488,0.000317054851343991,0.000471150554561052,0.000628893402663163,0.000788918322326569,0.000949669790887297,0.00110959095672868,0.00126701221577417,0.00142020247708101,0.00156739985822859,0.00170680834903375,0.00183663116017318,0.00195506571937285,0.00206032608809790,0.00215068772686709,0.00222448949800568,0.00228014037457413,0.00231614349452056,0.00233116407932595,0.00232394170126557,0.00229344375824166,0.00223877160669430,0.00215922379918702,0.00205431841496439,0.00192378929438465,0.00176761664964416,0.00158601485946296,0.00137945152527064,0.00114867115297797,0.000894683547688149,0.000618760837352780,0.000322446487029593,7.57448008542315e-06,-0.000323800816663752,-0.000669310804538530,-0.00102638103878341,-0.00139219188794126,-0.00176369485816498,-0.00213764669075882,-0.00251060854090728,-0.00287899309701910,-0.00323907396970748,-0.00358700234130781,-0.00391884960102205,-0.00423063693045761,-0.00451835909965688,-0.00477800891497694,-0.00500564795761089,-0.00519736699465807,-0.00534940352951754,-0.00545812279534534,-0.00552005945497251,-0.00553196513200722,-0.00549081841924653,-0.00539388319828135,-0.00523872043153096,-0.00502321193792878,-0.00474559862783399,-0.00440450161429388,-0.00399893835201259,-0.00352834088440054,-0.00299259062074630,-0.00239198009572580,-0.00172729171109297,-0.000999751255436570,-0.000211044732818302,0.000636672718963415,0.00154080514577147,0.00249829415300354,0.00350565392261346,0.00455898594509807,0.00565399003088759,0.00678599047534967,0.00794996555515041,0.00914057458937624,0.0103521819527585,0.0115789267418649,0.0128147031423601,0.0140532496947238,0.0152881714621887,0.0165129762963842,0.0177211434140225,0.0189061328826368,0.0200614597515458,0.0211807328212187,0.0222576939670331,0.0232862666317556,0.0242606003466536,0.0251751101920315,0.0260245156006313,0.0268039009418671,0.0275087064363513,0.0281348062908467,0.0286785173523470,0.0291366237725679,0.0295064248285956,0.0297857150662799,0.0299728361676950,0.0300666765770978,0.0300666765770978,0.0299728361676950,0.0297857150662799,0.0295064248285956,0.0291366237725679,0.0286785173523470,0.0281348062908467,0.0275087064363513,0.0268039009418671,0.0260245156006313,0.0251751101920315,0.0242606003466536,0.0232862666317556,0.0222576939670331,0.0211807328212187,0.0200614597515458,0.0189061328826368,0.0177211434140225,0.0165129762963842,0.0152881714621887,0.0140532496947238,0.0128147031423601,0.0115789267418649,0.0103521819527585,0.00914057458937624,0.00794996555515041,0.00678599047534967,0.00565399003088759,0.00455898594509807,0.00350565392261346,0.00249829415300354,0.00154080514577147,0.000636672718963415,-0.000211044732818302,-0.000999751255436570,-0.00172729171109297,-0.00239198009572580,-0.00299259062074630,-0.00352834088440054,-0.00399893835201259,-0.00440450161429388,-0.00474559862783399,-0.00502321193792878,-0.00523872043153096,-0.00539388319828135,-0.00549081841924653,-0.00553196513200722,-0.00552005945497251,-0.00545812279534534,-0.00534940352951754,-0.00519736699465807,-0.00500564795761089,-0.00477800891497694,-0.00451835909965688,-0.00423063693045761,-0.00391884960102205,-0.00358700234130781,-0.00323907396970748,-0.00287899309701910,-0.00251060854090728,-0.00213764669075882,-0.00176369485816498,-0.00139219188794126,-0.00102638103878341,-0.000669310804538530,-0.000323800816663752,7.57448008542315e-06,0.000322446487029593,0.000618760837352780,0.000894683547688149,0.00114867115297797,0.00137945152527064,0.00158601485946296,0.00176761664964416,0.00192378929438465,0.00205431841496439,0.00215922379918702,0.00223877160669430,0.00229344375824166,0.00232394170126557,0.00233116407932595,0.00231614349452056,0.00228014037457413,0.00222448949800568,0.00215068772686709,0.00206032608809790,0.00195506571937285,0.00183663116017318,0.00170680834903375,0.00156739985822859,0.00142020247708101,0.00126701221577417,0.00110959095672868,0.000949669790887297,0.000788918322326569,0.000628893402663163,0.000471150554561052,0.000317054851343991,0.000167940366930488,2.50026051317746e-05,-0.000110697102663998,-0.000238214625252847,-0.000356713223900428,-0.000465501135750361,-0.000564028415914168,-0.000651863609577927,-0.000728706958097283,-0.000794369411400013,-0.000848792994773484,-0.000892071954406799,-0.000924312674656017,-0.000945858638529490,-0.000957020586836878,-0.000958257697775645,-0.000950117565262102,-0.000933196723645475,-0.000908127506326589,-0.000875615638874054,-0.000836413796266533,-0.000791291260561520,-0.000741037621814470,-0.000686438549549766,-0.000628300176764747,-0.000567450331217877,-0.000504589905816540,-0.000440588239604649,-0.000376066023505732,-0.000311749035058021,-0.000248312819331449,-0.000186353183086686,-0.000126395144867116,-6.89493749203878e-05,-1.44729876149084e-05,3.66497970938765e-05,8.40965046267350e-05,0.000127616922549539,0.000166989788645684,0.000202033044726100,0.000232748538042406,0.000258908777237841,0.000280735133725278,0.000298178717625201,0.000311316443630082,0.000320318482618341,0.000325403386669524,0.000326761188423756,0.000324616570972084,0.000319234192899831,0.000310906571276894,0.000299950722476214,0.000286654204484094,0.000271309827906738,0.000254366995067474,0.000235803526478832,0.000216428578703830,0.000196218684986828,0.000175478687368925,0.000154551235335883,0.000133747099984571,0.000113253209649522,9.32648674840754e-05,7.39730418405623e-05,5.55755553661594e-05,3.82510341149398e-05,2.21013480837777e-05,7.22475490810853e-06,-6.09581720487578e-06,-1.87620889562028e-05,-2.89292280511830e-05,-3.81418191955563e-05,-4.60401338563882e-05,-5.24464439620379e-05,-5.72627411565912e-05,-6.06775372852928e-05,-6.28021442815492e-05,-6.38301129789967e-05,-6.38127740985618e-05,-6.28692390453495e-05,-6.10229386550884e-05,-5.83899233005294e-05,-5.50142418715581e-05,-0.000330979071680577];
coeff = [-1.37723983647336e-06,-6.71357140477664e-06,-1.33690126774032e-05,-2.16180922555433e-05,6.90437750596192e-05,-5.41629381130712e-05,-7.82356730624139e-05,0.000226799107556773,-0.000158579749848008,-0.000211750902636563,0.000564067973406603,-0.000368040627526545,-0.000467110150671507,0.00118163619796067,-0.000736964585115514,-0.000902528682390966,0.00220103468314004,-0.00132800187797152,-0.00158202613740931,0.00375067838464342,-0.00220456049213908,-0.00256737092630374,0.00594804028049499,-0.00342115430753605,-0.00390773181824193,0.00887799327854425,-0.00501227361744929,-0.00562831595200991,0.0125702765873602,-0.00698138202180577,-0.00771995614567738,0.0169800872935101,-0.00929220624301542,-0.0101315204520164,0.0219758434697172,-0.0118642232431191,-0.0127673455213670,0.0273378049061481,-0.0145739608748177,-0.0154906507305054,0.0327691642420907,-0.0172627748229335,-0.0181335676177457,0.0379202087311788,-0.0197506760024464,-0.0205127608169747,0.0424226509238576,-0.0218549028224419,-0.0224491255032623,0.0459301382219417,-0.0234104677915846,-0.0237883242393082,0.0481591016800838,-0.0242900561592300,-0.0244196894388355,0.0489236692845609,-0.0244196894388355,-0.0242900561592300,0.0481591016800838,-0.0237883242393082,-0.0234104677915846,0.0459301382219417,-0.0224491255032623,-0.0218549028224419,0.0424226509238576,-0.0205127608169747,-0.0197506760024464,0.0379202087311788,-0.0181335676177457,-0.0172627748229335,0.0327691642420907,-0.0154906507305054,-0.0145739608748177,0.0273378049061481,-0.0127673455213670,-0.0118642232431191,0.0219758434697172,-0.0101315204520164,-0.00929220624301542,0.0169800872935101,-0.00771995614567738,-0.00698138202180577,0.0125702765873602,-0.00562831595200991,-0.00501227361744929,0.00887799327854425,-0.00390773181824193,-0.00342115430753605,0.00594804028049499,-0.00256737092630374,-0.00220456049213908,0.00375067838464342,-0.00158202613740931,-0.00132800187797152,0.00220103468314004,-0.000902528682390966,-0.000736964585115514,0.00118163619796067,-0.000467110150671507,-0.000368040627526545,0.000564067973406603,-0.000211750902636563,-0.000158579749848008,0.000226799107556773,-7.82356730624139e-05,-5.41629381130712e-05,6.90437750596192e-05,-2.16180922555433e-05,-1.33690126774032e-05,-6.71357140477664e-06,-1.37723983647336e-06];
%生成的滤波系数
out =conv(y,coeff);%卷积

% draw waveform
figure(1);
subplot(2,2,1);
plot(y);
xlabel('滤波前');
axis([0 200 -6 6]);%调整横纵比
subplot(2,2,2);
plot(out);
xlabel('滤波后');
axis([0 200 -4 4]);

%频谱图
%figure(2);
df = Fs / ( len - 1 );
f = ( 0 : len ) * df;
Y1 = fft(y);
subplot(2,2,3);
plot(f(1:len/2),abs(Y1(1:len/2)),'r','LineWidth',1.2);
set(gca,'LineWidth',1.2);

Y2 = fft(out);
subplot(2,2,4);
plot(f(1:len/2),abs(Y2(1:len/2)),'r','LineWidth',1.2);
axis([0 6*10^6 0 600]);
set(gca,'LineWidth',1.2);



